name: CI Pipeline

on:
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:

  # ----------------------------------------------------------
  # 1. PHPCS — Fastest & first quality gate
  # ----------------------------------------------------------
  phpcs:
    name: PHPCS Code Style
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: Install Composer Dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run PHPCS
        run: vendor/bin/phpcs -p --standard=phpcs.xml | tee phpcs.log

      - name: Upload PHPCS Log
        uses: actions/upload-artifact@v4
        with:
          name: phpcs-log
          path: phpcs.log


  # ----------------------------------------------------------
  # 2. PHPStan — static analysis
  # ----------------------------------------------------------
  phpstan:
    name: PHPStan Static Analysis
    runs-on: ubuntu-latest
    needs: phpcs

    steps:
      - uses: actions/checkout@v4

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, intl, pdo_mysql

      - run: composer install --no-interaction --prefer-dist

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --memory-limit=1G --no-progress | tee phpstan.log

      - name: Upload PHPStan Log
        uses: actions/upload-artifact@v4
        with:
          name: phpstan-log
          path: phpstan.log


  # ----------------------------------------------------------
  # 3. PHPUnit — Laravel Sail
  # ----------------------------------------------------------
  phpunit:
    name: PHPUnit Tests (Laravel Sail)
    runs-on: ubuntu-latest
    needs: phpstan

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - name: Prepare .env.testing
        run: |
          cp .env.example .env
          php -r "file_put_contents('.env', preg_replace('/DB_DATABASE=.*/', 'DB_DATABASE=testing', file_get_contents('.env')));"

      - name: Start Sail
        run: |
          ./vendor/bin/sail up -d
          sleep 25

      - name: Run Migrations
        run: ./vendor/bin/sail artisan migrate --force

      - name: Run Tests
        run: ./vendor/bin/sail artisan test --parallel --log-junit junit.xml

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-results
          path: junit.xml


  # ----------------------------------------------------------
  # 4. Pint
  # ----------------------------------------------------------
  pint:
    name: Laravel Pint Formatter
    runs-on: ubuntu-latest
    needs: phpunit

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: Install Composer Dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run Pint (test mode)
        run: vendor/bin/pint --test | tee pint.log

      - uses: actions/upload-artifact@v4
        with:
          name: pint-log
          path: pint.log


  # ----------------------------------------------------------
  # 5. Notifications — only when CI fails
  # ----------------------------------------------------------
  notify:
    name: Failure Alerts
    runs-on: ubuntu-latest
    needs: pint
    if: failure()

    steps:
      - name: Slack alert
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": ":rotating_light: CI Failed on `${{ github.ref_name }}`. Check logs."
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "CI Pipeline Failed — ${{ github.ref_name }}"
          to: ${{ secrets.ALERT_EMAIL }}
          from: "CI Bot <ci@example.com>"
          body: "The CI pipeline has failed. Logs are available in GitHub Actions."
