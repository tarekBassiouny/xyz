name: CI Pipeline

on:
  pull_request:
    branches:
      - dev
      - main
  workflow_dispatch:

jobs:

  # ----------------------------------------------------------
  # 1. PHPCS
  # ----------------------------------------------------------
  phpcs:
    name: PHPCS Code Style
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"

      - name: Install Composer Dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run PHPCS
        run: vendor/bin/phpcs -p --standard=phpcs.xml | tee phpcs.log

      - name: Upload PHPCS Log
        uses: actions/upload-artifact@v4
        with:
          name: phpcs-log
          path: phpcs.log


  # ----------------------------------------------------------
  # 2. PHPStan
  # ----------------------------------------------------------
  phpstan:
    name: PHPStan Static Analysis
    runs-on: ubuntu-latest
    needs: phpcs

    steps:
      - uses: actions/checkout@v4

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: mbstring, intl, pdo_mysql

      - run: composer install --no-interaction --prefer-dist

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --memory-limit=1G --no-progress | tee phpstan.log

      - name: Upload PHPStan Log
        uses: actions/upload-artifact@v4
        with:
          name: phpstan-log
          path: phpstan.log


  # ----------------------------------------------------------
  # 3. PHPUnit (Laravel Sail)
  # ----------------------------------------------------------
  phpunit:
    name: PHPUnit Tests
    runs-on: ubuntu-latest
    needs: phpstan

    services:
      mysql:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=10

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.4
        extensions: mbstring, intl, pdo_mysql, bcmath, xml, fileinfo

    - uses: actions/cache@v3
      with:
        path: vendor
        key: composer-${{ hashFiles('composer.lock') }}

    - name: Install Dependencies
      run: composer install --prefer-dist --no-interaction

    - name: Prepare .env.testing
      run: |
        cp .env.example .env
        php -r "file_put_contents('.env', preg_replace('/DB_DATABASE=.*/', 'DB_DATABASE=testing', file_get_contents('.env')));"

    - name: Wait for MySQL
      run: |
        for i in {1..20}; do
          mysql -h 127.0.0.1 -uroot -proot -e "SELECT 1" && break
          sleep 2
        done

    - name: Run Migrations
      run: php artisan migrate --force

    - name: Run Tests
      run: php artisan test --parallel --log-junit junit.xml

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: phpunit-results
        path: junit.xml

  # ----------------------------------------------------------
  # 4. Pint
  # ----------------------------------------------------------
  pint:
    name: Laravel Pint Formatter
    runs-on: ubuntu-latest
    needs: phpunit

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"

      - name: Install Composer Dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run Pint (test mode)
        run: vendor/bin/pint --test | tee pint.log

      - uses: actions/upload-artifact@v4
        with:
          name: pint-log
          path: pint.log


  # ----------------------------------------------------------
  # 5. Notifications (only on failure)
  # ----------------------------------------------------------
  notify:
    name: Failure Alerts
    runs-on: ubuntu-latest
    needs: pint
    if: failure()

    steps:
      - name: Slack alert
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": ":rotating_light: CI Failed on `${{ github.ref_name }}`. Check logs."
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "CI Pipeline Failed â€” ${{ github.ref_name }}"
          to: ${{ secrets.ALERT_EMAIL }}
          from: "CI Bot <ci@example.com>"
          body: "The CI pipeline has failed. Logs are available in GitHub Actions."
