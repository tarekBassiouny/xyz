---
# yamllint disable rule:line-length rule:truthy
name: Sync main to dev

on:
  workflow_run:
    workflows:
      - "Create Release Tag"
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    if: >-
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
      || (github.event_name == 'workflow_run'
      && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Determine tag from event
        id: tag
        run: |
          tag="${GITHUB_REF_NAME#refs/tags/}"
          if [ -z "$tag" ]; then
            tag=$(git describe --tags --abbrev=0)
          fi
          if [ -z "$tag" ]; then
            echo "No tag found" >&2
            exit 1
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Get release notes
        id: notes
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_PAT }}
        run: |
          notes=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.tag.outputs.tag }}" \
            | jq -r '.body')
          printf 'notes<<__EOF__\n%s\n__EOF__\n' "$notes" >> "$GITHUB_OUTPUT"

      - name: Ensure automation label exists
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_PAT }}
        run: |
          gh label create automation --color FF8800 || true
          gh label create sync --color BFD4F2 || true

      - name: Create PR main â†’ dev
        id: pr
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_PAT }}
          TAG: ${{ steps.tag.outputs.tag }}
          NOTES: ${{ steps.notes.outputs.notes }}
        run: |
          # Check if PR already exists
          PR_NUMBER=$(gh pr list \
            --base dev \
            --head main \
            --json number \
            --jq '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            printf '%s\n' \
              '## ðŸ”„ Automated Sync PR' \
              "**Release:** \`$TAG\`" \
              '' \
              '### ðŸ“¦ Release Notes' \
              "$NOTES" \
              '' \
              '---' \
              'âš ï¸ **IMPORTANT:** This PR must be merged using **Rebase and Merge** only.' \
              'Using merge commits or squash merging will break branch alignment.' \
              '' \
              'This PR ensures **dev** stays ahead of **main** after a release.' \
              > pr_body.txt

            gh pr create \
              --base dev \
              --head main \
              --title "ðŸ”„ Sync main â†’ dev after release $TAG" \
              --body-file pr_body.txt \
              --label automation \
              --label sync 

            PR_NUMBER=$(gh pr list --base dev --head main --json number --jq '.[0].number')
          fi

          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
